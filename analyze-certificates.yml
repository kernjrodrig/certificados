---
# Playbook para analizar certificados en el directorio roles/certificado/files
- name: Analizar certificados en el directorio roles/certificado/files
  hosts: localhost
  gather_facts: false
  become: false
  vars:
    certs_dir: "{{ playbook_dir }}/roles/certificado/files"

  tasks:
    - name: Listar archivos de certificados
      ansible.builtin.find:
        paths: "{{ certs_dir }}"
        patterns:
          - "*.crt"
          - "*.cer"
          - "*.pem"
          - "*.key"
          - "*.pfx"
        file_type: file
      register: cert_files

    - name: Mostrar archivos encontrados
      ansible.builtin.debug:
        msg: "Archivos encontrados: {{ cert_files.files | map(attribute='path') | list }}"

    - name: Analizar certificados .crt y .cer
      community.crypto.x509_certificate_info:
        path: "{{ item.path }}"
      register: cert_info
      loop: "{{ cert_files.files }}"
      when: item.path | regex_search('\.(crt|cer|pem)$')
      ignore_errors: true

    - name: Mostrar informaciÃ³n detallada de cada certificado
      ansible.builtin.debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ğŸ“„ Certificado: {{ item.item.path | basename }}"
          - "ğŸ“ Ruta completa: {{ item.item.path }}"
          - "ğŸ“‹ Subject: {{ item.cert_info.subject | default('N/A') }}"
          - "ğŸ¢ Issuer: {{ item.cert_info.issuer | default('N/A') }}"
          - "ğŸ“… VÃ¡lido desde: {{ (item.cert_info.not_before | to_datetime('%Y%m%d%H%M%SZ')).strftime('%d/%m/%Y %H:%M:%S UTC') if item.cert_info.not_before is defined else 'N/A' }}"
          - "â° VÃ¡lido hasta: {{ (item.cert_info.not_after | to_datetime('%Y%m%d%H%M%SZ')).strftime('%d/%m/%Y %H:%M:%S UTC') if item.cert_info.not_after is defined else 'N/A' }}"
          - "ğŸ“Š DÃ­as restantes: {{ (((item.cert_info.not_after | to_datetime('%Y%m%d%H%M%SZ')).timestamp() | int) - (lookup('pipe', 'date +%s') | int)) // 86400 | int if item.cert_info.not_after is defined else 'N/A' }}"
          - "ğŸ” Serial Number: {{ item.cert_info.serial_number | default('N/A') }}"
          - "ğŸ”‘ Key Size: {{ item.cert_info.public_key | default('N/A') }}"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      loop: "{{ cert_info.results | default([]) }}"
      when: 
        - item.cert_info is defined
        - item.cert_info.not_after is defined
      loop_control:
        label: "{{ item.item.path | basename }}"

    - name: Verificar llaves privadas
      ansible.builtin.stat:
        path: "{{ item.path }}"
      register: key_files
      loop: "{{ cert_files.files }}"
      when: item.path | regex_search('\.(key)$')

    - name: Mostrar informaciÃ³n de llaves privadas
      ansible.builtin.debug:
        msg:
          - "ğŸ”‘ Llave privada: {{ item.item.path | basename }}"
          - "ğŸ“ Ruta: {{ item.item.path }}"
          - "ğŸ“Š TamaÃ±o: {{ item.stat.size | default(0) }} bytes"
          - "ğŸ”’ Permisos: {{ item.stat.mode | default('N/A') }}"
      loop: "{{ key_files.results | default([]) }}"
      when: item.stat.exists

    - name: Resumen de certificados
      ansible.builtin.debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ğŸ“Š RESUMEN DE CERTIFICADOS"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "Total de archivos encontrados: {{ cert_files.files | length }}"
          - "Certificados analizados: {{ cert_info.results | selectattr('cert_info', 'defined') | selectattr('cert_info.not_after', 'defined') | list | length }}"
          - "Llaves privadas: {{ key_files.results | selectattr('stat.exists') | list | length }}"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

